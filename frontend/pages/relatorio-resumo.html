 <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Resumo para Impressão</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tipografia limpa para impressão -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb;
      --card:#f9fafb;
    }
    * { box-sizing: border-box; }
    html,body { margin:0; padding:0; color:var(--ink); font: 14px/1.45 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#fff; }
    .wrap { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    header { display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); padding-bottom:14px; margin-bottom:16px; }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand-badge { width:36px; height:36px; border-radius:10px; background:var(--accent); color:#fff; display:grid; place-items:center; font-weight:700; }
    h1 { font-size:18px; margin:0; }
    .meta { color:var(--muted); font-size:12px; }
    .grid { display:grid; gap:10px; grid-template-columns: repeat(4, minmax(0,1fr)); margin: 14px 0 8px; }
    .card {
      background: var(--card);
      border:1px solid var(--line);
      border-radius:10px;
      padding:12px;
    }
    .k-title { color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.04em; }
    .k-value { font-size:18px; font-weight:700; margin-top:2px; }
    .section { margin-top:18px; }
    .section h2 { font-size:14px; margin:0 0 8px; padding-bottom:6px; border-bottom:1px solid var(--line); }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--line); }
    th { font-size:12px; color:var(--muted); font-weight:600; }
    td.num { text-align:right; }
    .foot { display:flex; justify-content:space-between; align-items:center; margin-top:16px; padding-top:12px; border-top:1px solid var(--line); color:var(--muted); font-size:12px; }
    .pill { display:inline-block; border:1px solid var(--line); background:#fff; border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); }
    .muted { color:var(--muted); }
    .small { font-size:12px; }
    .hide { display:none; }

    /* impressão */
    @media print {
      .no-print { display:none !important; }
      body { background:#fff; }
      .wrap { margin:0 auto; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-badge">PA</div>
        <div>
          <h1 id="titulo">Resumo</h1>
          <div class="meta" id="subtitulo">—</div>
        </div>
      </div>
      <div class="meta">
        <div id="geradoEm"></div>
        <div id="usuarioInfo" class="small"></div>
      </div>
    </header>

    <!-- KPIs -->
    <div class="grid" id="kpis">
      <!-- Preenchido via JS conforme o tipo -->
    </div>

    <!-- Sessões complementares -->
    <div class="section" id="sec-top-list" class="hide">
      <h2 id="top-title">Top itens</h2>
      <table id="top-table">
        <thead><tr id="top-head"></tr></thead>
        <tbody id="top-body"></tbody>
      </table>
    </div>

    <div class="section" id="sec-detalhes" class="hide">
      <h2 id="detalhes-title">Detalhes</h2>
      <table id="detalhes-table">
        <thead><tr id="detalhes-head"></tr></thead>
        <tbody id="detalhes-body"></tbody>
      </table>
    </div>

    <div class="foot">
      <span class="pill" id="filtroPill">Filtros: —</span>
      <span class="muted small">Planeta Água • Relatório resumido</span>
    </div>

    <div class="no-print" style="margin-top:14px; text-align:right;">
      <button id="btnPrint" style="border:1px solid var(--line); background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer;">Imprimir</button>
    </div>
  </div>

  <script>
    // ========= Helpers =========
    const API_BASE = localStorage.getItem("API_BASE") || "";
    const token = (localStorage.getItem("token") || "").replace(/^Bearer\\s+/i,'').trim();

    function authHeaders() {
      return token ? { "Authorization": "Bearer " + token, "Content-Type": "application/json" } : {};
    }
    async function apiGet(path) {
      const res = await fetch(API_BASE + path, { headers: authHeaders() });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json().catch(() => ({}));
      return json?.dados ?? json;
    }
    const BRL = new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" });
    const fmt = (n) => BRL.format(Number(n||0));
    const qs = new URLSearchParams(location.search);
    const type = qs.get("type") || "vendas-diario";

    function setTitle(title, subtitle) {
      document.getElementById("titulo").textContent = title;
      document.getElementById("subtitulo").textContent = subtitle || "";
      document.getElementById("geradoEm").textContent = "Gerado em " + new Date().toLocaleString("pt-BR");
    }
    function setFiltrosPill(text) {
      document.getElementById("filtroPill").textContent = "Filtros: " + (text || "—");
    }
    function kpi(label, value) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = '<div class="k-title">'+label+'</div><div class="k-value">'+value+'</div>';
      return div;
    }
    function renderHead(rowEl, cols) {
      rowEl.innerHTML = "";
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        rowEl.appendChild(th);
      });
    }
    function renderRows(tbody, rows, numericIdx = []) {
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        r.forEach((cell, idx) => {
          const td = document.createElement("td");
          if (numericIdx.includes(idx)) td.classList.add("num");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    function show(id, on=true) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = on ? "" : "none";
    }

    // ========= Rotas por tipo =========
    async function run() {
      document.getElementById("btnPrint").addEventListener("click", () => window.print());

      if (!token) {
        alert("Sessão expirada. Faça login novamente.");
        return;
      }

      try {
        if (type === "vendas-diario") {
          const data = qs.get("data");
          const vendedorId = qs.get("vendedorId");
          const payload = await apiGet(`/api/relatorios/vendas/diario?data=${encodeURIComponent(data||"")}${vendedorId?("&vendedorId="+vendedorId):""}`);

          setTitle("Relatório de Vendas (Diário)", new Date(payload.data).toLocaleDateString("pt-BR"));
          setFiltrosPill(`Data: ${new Date(payload.data).toLocaleDateString("pt-BR")}${vendedorId?(", Vendedor: "+vendedorId):""}`);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Faturamento", fmt(payload.faturamento)),
            kpi("Total de Vendas", String(payload.totalVendas)),
            kpi("Ticket Médio", fmt(payload.ticketMedio)),
            kpi("Clientes Atendidos", String(payload.clientesAtendidos)),
          );

          // TOP produtos
          const top = (payload.produtos || []).sort((a,b)=>b.valor-a.valor).slice(0,6);
          if (top.length) {
            show("sec-top-list", true);
            document.getElementById("top-title").textContent = "Produtos mais vendidos (Top 6)";
            renderHead(document.getElementById("top-head"), ["Produto", "Qtd.", "Valor"]);
            renderRows(
              document.getElementById("top-body"),
              top.map(p => [p.nome, String(p.quantidade), fmt(p.valor)]),
              [2]
            );
          } else { show("sec-top-list", false); }

          // Detalhes enxutos
          const linhas = (payload.vendas || []).map(v => [v.hora, v.cliente, v.pagamento, fmt(v.valor)]);
          if (linhas.length) {
            show("sec-detalhes", true);
            document.getElementById("detalhes-title").textContent = "Vendas do dia (resumo)";
            renderHead(document.getElementById("detalhes-head"), ["Hora", "Cliente", "Pagamento", "Valor"]);
            renderRows(document.getElementById("detalhes-body"), linhas, [3]);
          } else { show("sec-detalhes", false); }

        } else if (type === "vendas-mensal") {
          const ano = qs.get("ano"); const mes = qs.get("mes");
          const payload = await apiGet(`/api/relatorios/vendas/mensal?ano=${ano}&mes=${mes}`);
          setTitle("Relatório de Vendas (Mensal)", `Mês ${String(mes).padStart(2,"0")}/${ano}`);
          setFiltrosPill(`Mês/Ano: ${String(mes).padStart(2,"0")}/${ano}`);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Faturamento no Mês", fmt(payload.faturamento)),
            kpi("Total de Vendas", String(payload.totalVendas)),
            kpi("Ticket Médio", fmt(payload.ticketMedio)),
            kpi("Novos Clientes", String(payload.novosClientes || 0)),
          );

          const top = (payload.produtos || []).sort((a,b)=>b.valor-a.valor).slice(0,8);
          if (top.length) {
            show("sec-top-list", true);
            document.getElementById("top-title").textContent = "Produtos do mês (Top 8 por valor)";
            renderHead(document.getElementById("top-head"), ["Produto", "Qtd.", "Valor"]);
            renderRows(document.getElementById("top-body"), top.map(p => [p.nome, String(p.quantidade), fmt(p.valor)]), [2]);
          } else { show("sec-top-list", false); }

          show("sec-detalhes", false); // mensal resumido sem tabela longa

        } else if (type === "vendas-anual") {
          const ano = qs.get("ano");
          const payload = await apiGet(`/api/relatorios/vendas/anual?ano=${ano}`);
          setTitle("Relatório de Vendas (Anual)", `Ano ${ano}`);
          setFiltrosPill(`Ano: ${ano}`);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Faturamento do Ano", fmt(payload.faturamento)),
            kpi("Total de Vendas", String(payload.totalVendas)),
            kpi("Ticket Médio", fmt(payload.ticketMedio)),
            kpi("Clientes Únicos", String(payload.clientesUnicos || 0)),
          );
          show("sec-top-list", false);
          show("sec-detalhes", false);

        } else if (type === "vendas-personalizado") {
          const inicio = qs.get("inicio"), fim = qs.get("fim");
          const payload = await apiGet(`/api/relatorios/vendas/personalizado?inicio=${inicio}&fim=${fim}`);
          const periodo = `${new Date(inicio).toLocaleDateString("pt-BR")} a ${new Date(fim).toLocaleDateString("pt-BR")}`;
          setTitle("Relatório de Vendas (Período)", periodo);
          setFiltrosPill("Período: " + periodo);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Faturamento", fmt(payload.faturamento)),
            kpi("Total de Vendas", String(payload.totalVendas)),
            kpi("Ticket Médio", fmt(payload.ticketMedio)),
            kpi("Clientes Únicos", String(payload.clientes || 0)),
          );

          const linhas = (payload.vendas || []).map(v => [
            new Date(v.data).toLocaleDateString("pt-BR"),
            v.cliente, v.vendedor, v.pagamento, fmt(v.valor)
          ]);
          if (linhas.length) {
            show("sec-detalhes", true);
            document.getElementById("detalhes-title").textContent = "Vendas no período (resumo)";
            renderHead(document.getElementById("detalhes-head"), ["Data", "Cliente", "Vendedor", "Pagamento", "Valor"]);
            renderRows(document.getElementById("detalhes-body"), linhas, [4]);
          } else { show("sec-detalhes", false); }
          show("sec-top-list", false);

        } else if (type === "estoque-atual") {
          const categoria = qs.get("categoria") || "todos";
          const status = qs.get("status") || "todos";
          const payload = await apiGet(`/api/relatorios/estoque/atual?categoria=${encodeURIComponent(categoria)}&status=${encodeURIComponent(status)}`);

          setTitle("Relatório de Estoque (Atual)", "Visão resumida");
          setFiltrosPill(`Categoria: ${categoria} • Status: ${status}`);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Total de Produtos", String(payload.totalProdutos)),
            kpi("Estoque Baixo", String(payload.estoqueBaixo)),
            kpi("Próximos a Vencer", String(payload.proximosVencer || 0)),
            kpi("Valor em Estoque", fmt(payload.valorEstoque)),
          );

          const top = (payload.produtos || [])
            .sort((a,b)=>b.valorTotal-a.valorTotal)
            .slice(0,12)
            .map(p => [p.produto, p.tipo, String(p.quantidade), p.status, fmt(p.valorTotal)]);

          if (top.length) {
            show("sec-top-list", true);
            document.getElementById("top-title").textContent = "Produtos (Top 12 por valor)";
            renderHead(document.getElementById("top-head"), ["Produto", "Categoria", "Qtd.", "Status", "Valor Total"]);
            renderRows(document.getElementById("top-body"), top, [2,4]);
          } else { show("sec-top-list", false); }
          show("sec-detalhes", false);

        } else if (type === "estoque-movimentacao") {
          const inicio = qs.get("inicio"), fim = qs.get("fim");
          const payload = await apiGet(`/api/relatorios/estoque/movimentacao?inicio=${inicio}&fim=${fim}`);
          const periodo = `${new Date(inicio).toLocaleDateString("pt-BR")} a ${new Date(fim).toLocaleDateString("pt-BR")}`;
          setTitle("Relatório de Estoque (Movimentação)", periodo);
          setFiltrosPill("Período: " + periodo);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          kpis.append(
            kpi("Entradas", String(payload.entradas || 0)),
            kpi("Saídas", String(payload.saidas || payload["saídas"] || 0)),
            kpi("Saldo (unid.)", String(payload.saldo || 0)),
            kpi("Valor Movimentado", fmt(payload.valorMovimentado || 0)),
          );

          const linhas = (payload.movimentacoes || []).slice(0,20).map(m => [
            new Date(m.data).toLocaleDateString("pt-BR"),
            m.produto, m.tipo === "saida" ? "Saída" : "Entrada",
            String(m.quantidade), fmt(m.valor)
          ]);
          if (linhas.length) {
            show("sec-detalhes", true);
            document.getElementById("detalhes-title").textContent = "Movimentações (amostra)";
            renderHead(document.getElementById("detalhes-head"), ["Data", "Produto", "Tipo", "Qtd.", "Valor"]);
            renderRows(document.getElementById("detalhes-body"), linhas, [3,4]);
          } else { show("sec-detalhes", false); }
          show("sec-top-list", false);

        } else if (type === "estoque-validade") {
          const dias = qs.get("dias") || "30";
          const payload = await apiGet(`/api/relatorios/estoque/validade?dias=${dias}`);
          setTitle("Relatório de Validade", `Período: próximos ${payload.periodo}`);
          setFiltrosPill(`Janela: ${payload.periodo}`);

          const kpis = document.getElementById("kpis");
          kpis.innerHTML = "";
          const proximos = (payload.produtos || []).filter(p => p.status === "Próximo a vencer").length;
          kpis.append(
            kpi("Itens listados", String((payload.produtos || []).length)),
            kpi("Próximo a vencer", String(proximos)),
            kpi("Janela", String(payload.periodo || "-")),
            kpi("Data base", new Date().toLocaleDateString("pt-BR")),
          );

          const linhas = (payload.produtos || []).slice(0,18).map(p => [
            p.produto, p.lote || "-", new Date(p.validade).toLocaleDateString("pt-BR"),
            String(p.diasRestantes), String(p.quantidade), p.status
          ]);
          if (linhas.length) {
            show("sec-detalhes", true);
            document.getElementById("detalhes-title").textContent = "Produtos por validade (amostra)";
            renderHead(document.getElementById("detalhes-head"), ["Produto", "Lote", "Validade", "Dias", "Qtd.", "Status"]);
            renderRows(document.getElementById("detalhes-body"), linhas, [3,4]);
          } else { show("sec-detalhes", false); }
          show("sec-top-list", false);
        }

        // Imprimir automaticamente após render (pequeno delay p/ fontes)
        setTimeout(() => window.print(), 300);

      } catch (e) {
        alert("Falha ao gerar resumo: " + (e.message || e));
      }
    }

    run();
  </script>
</body>
</html>
